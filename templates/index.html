<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ba√∫ de Receitas - Forja de Receitas √âpicas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> {# Corrigido url_for para 'static' #}
</head>
<body>
    <div class="main-container"> {# Add main-container class #}
        <h1>‚öîÔ∏è Ba√∫ de Receitas ‚öîÔ∏è</h1>
        <p>Bem-vindo ao Ba√∫ de Receitas! Entre na <strong>Forja de F√≥rmulas √âpicas</strong>!</p>
        <p>Informe os ingredientes que voc√™ possui em seu invent√°rio, e nossos Mestres Culin√°rios Alquimistas conjurar√£o uma receita exclusiva para voc√™.</p>
        <hr>

        <h2>üî• A Forja de F√≥rmulas √âpicas üî•</h2>

        <div class="input-area"> {# Optional: Add a class for input area if specific styling is needed #}
            <h3>üìú Ingredientes em Seu Invent√°rio:</h3>
            <form method="POST" id="recipe-form">
                <textarea name="ingredients" rows="4" placeholder="Ex: casca de ab√≥bora, talo de br√≥colis, p√£o amanhecido, cenoura murcha...">{{ ingredients }}</textarea>
                <button type="submit" id="submit-button">‚ú® FORJAR RECEITA! ‚ú®</button>
            </form>
        </div>

        <div class="recipe-output-area" > {# Add recipe-output-area class #}
           {# √Årea para exibir mensagens de status durante o processamento #}
           {# Este div ser√° controlado INTEIRAMENTE pelo JavaScript no cliente #}
            <div id="processing-status" class="status-message" style="display: none;">
                <p id="current-status-text">Iniciando forja...</p>
                <div id="step-status-container">
                    <p id="buscador-status" class="step-status"><span>üîç Vasculhando tomos antigos por receitas compat√≠veis...</span></p> {# Removido ID duplicado #}
                    <p id="planejador-status" class="step-status"><span>üó∫Ô∏è Decifrando e planejando a receita principal...</span></p> {# Removido ID duplicado #}
                    <p id="redator-status" class="step-status"><span>‚úçÔ∏è Transcrevendo o encantamento... digo, o tutorial da receita...</span></p> {# Removido ID duplicado #}
                </div>
            </div>

            <div id="final-output">
                {% if error_message %}
                    <div class="error-message">{{ error_message }}</div> {# Add error-message class #}
                {% elif rendered_recipe_html %} {# Use a nova vari√°vel para o HTML renderizado #}
                    <div class="recipe-content" id="recipe-display-area"> {# ID mais descritivo para o conte√∫do da receita #}
                        {{ rendered_recipe_html | safe }} {# O | safe ainda √© necess√°rio #}
                    </div>
                    {# Modifica√ß√£o PRINCIPAL aqui: Armazenar o markdown em um atributo data- e remover o href #}
                    {# O atributo download j√° est√° correto #}
                    <a id="download-button" download="{{ download_filename }}" data-markdown-content="{{ raw_markdown_content_for_download | e }}">üìú Baixar Pergaminho da Receita</a> {# Use | e para escapar HTML #}
                {% else %}
                    <div class="info-message"> {# Mostra mensagem inicial se nada foi processado #}
                        <p>Sua receita √©pica aparecer√° aqui ap√≥s a forja!</p>
                        <p>Prepare seus utens√≠lios e acenda o fogo do drag√£o!</p>
                        <p>Informe os ingredientes que voc√™ possui para come√ßar!</p> {# Adicionado um CTA #}
                    </div>
                {% endif %}
            </div> {# Close final-output div #}
        </div> {# Close recipe-output-area div #}

        <hr>
        <div class="footer-custom"> {# Keep footer-custom class #}
            <p>&copy; 2025 Ba√∫ de Receitas. Todos os direitos reservados. Forjado com Magia e Aproveitamento.</p>
        </div>
    </div> {# Close main-container div #}

    <script>
        // Refer√™ncias aos elementos
        const form = document.getElementById('recipe-form');
        const submitButton = document.getElementById('submit-button');
        const processingStatusDiv = document.getElementById('processing-status');
        // const currentStatusText = document.getElementById('current-status-text'); // N√£o usado diretamente, removido
        const stepStatusContainer = document.getElementById('step-status-container');
        const buscadorStatus = document.getElementById('buscador-status');
        const planejadorStatus = document.getElementById('planejador-status');
        const redatorStatus = document.getElementById('redator-status');
        const finalOutputDiv = document.getElementById('final-output'); // Onde o resultado final e o bot√£o de download aparecem

        const steps = [ // Ordem e elementos dos passos
            { id: 'buscador', element: buscadorStatus, text: 'üîç Pergaminhos encontrados!' },
            { id: 'planejador', element: planejadorStatus, text: 'üó∫Ô∏è Plano da receita tra√ßado!' },
            { id: 'redator', element: redatorStatus, text: '‚úçÔ∏è A f√≥rmula m√°gica est√° pronta!' }
        ];
        let currentStepIndex = 0;
        let animationInterval = null; // Para controlar a anima√ß√£o fake

        // Fun√ß√£o para resetar a UI para o estado inicial ou de carregamento
        function resetUI() {
            submitButton.disabled = false; // Garantir que o bot√£o n√£o fique desabilitado ao resetar
            processingStatusDiv.style.display = 'none'; // Esconde a √°rea de status
            finalOutputDiv.innerHTML = ''; // Limpa o conte√∫do final (receita/erro/info)
            currentStepIndex = 0;
            stopFakeAnimation(); // Para qualquer anima√ß√£o em andamento
            // Resetar o texto dos passos para o estado inicial
            steps.forEach(step => {
                step.element.style.display = 'none';
                step.element.classList.remove('active');
            });
            buscadorStatus.textContent = 'üîç Vasculhando tomos antigos por receitas compat√≠veis...';
            planejadorStatus.textContent = 'üó∫Ô∏è Decifrando e planejando a receita principal...';
            redatorStatus.textContent = '‚úçÔ∏è Transcrevendo o encantamento... digo, o tutorial da receita...';

            // Adiciona a mensagem informativa inicial
             finalOutputDiv.innerHTML = `<div class="info-message">
                <p>Sua receita √©pica aparecer√° aqui ap√≥s a forja!</p>
                <p>Prepare seus utens√≠lios e acenda o fogo do drag√£o!</p>
                <p>Informe os ingredientes que voc√™ possui para come√ßar!</p>
            </div>`;
        }

        // Fun√ß√£o para iniciar a anima√ß√£o cliente-side fake
        function startFakeAnimation() {
             // Certifica-se de que todos os passos est√£o ocultos antes de come√ßar
             steps.forEach(step => step.element.style.display = 'none');

            currentStepIndex = 0;
            // Mostra o primeiro passo imediatamente e o ativa
            steps[currentStepIndex].element.style.display = 'block';
            steps[currentStepIndex].element.classList.add('active');

            // Inicia o intervalo para trocar de passo (anima√ß√£o fake)
            animationInterval = setInterval(() => {
                // Remove a classe 'active' do passo atual antes de avan√ßar
                steps[currentStepIndex].element.classList.remove('active');

                // Avan√ßa para o pr√≥ximo passo
                currentStepIndex++;

                // Se for al√©m do √∫ltimo passo, volta para o primeiro e reseta o texto
                if (currentStepIndex >= steps.length) {
                    currentStepIndex = 0;
                     // Resetar o texto dos passos para o estado inicial (simula rein√≠cio)
                     buscadorStatus.textContent = 'üîç Vasculhando tomos antigos por receitas compat√≠veis...';
                     planejadorStatus.textContent = 'üó∫Ô∏è Decifrando e planejando a receita principal...';
                     redatorStatus.textContent = '‚úçÔ∏è Transcrevendo o encantamento... digo, o tutorial da receita...';
                    // Esconde todos os passos brevemente para simular "reiniciando"
                    steps.forEach(step => step.element.style.display = 'none');
                } else {
                     // Se ainda est√° avan√ßando, atualiza o texto do passo COMPLETO anterior (opcional, para mostrar "conclu√≠do")
                     // Depende se voc√™ quer que o texto mude para "Conclu√≠do!" ou fique o original
                     // Mantive o texto original conforme seus elementos HTML sugeriam
                }


                // Mostra e ativa o novo passo atual
                steps[currentStepIndex].element.style.display = 'block';
                steps[currentStepIndex].element.classList.add('active');

            }, 6000); // Troca de passo a cada 6 segundos
        }


        // Fun√ß√£o para parar a anima√ß√£o cliente-side
        function stopFakeAnimation() {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
             // Esconde todos os passos ao parar a anima√ß√£o
             steps.forEach(step => {
                 step.element.style.display = 'none';
                 step.element.classList.remove('active');
             });
        }

        // --- Event Listener para o formul√°rio ---
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Previne o envio padr√£o do formul√°rio

            // Valida√ß√£o simples: verificar se o textarea n√£o est√° vazio
            const ingredientsTextarea = form.querySelector('textarea[name="ingredients"]');
            if (!ingredientsTextarea || ingredientsTextarea.value.trim() === '') {
                // Exibe uma mensagem de erro ou alerta simples se estiver vazio
                 finalOutputDiv.innerHTML = `<div class="error-message">Por favor, informe pelo menos um ingrediente para forjar sua receita!</div>`;
                 // Opcional: esconde a √°rea de status se estava vis√≠vel de uma tentativa anterior
                 processingStatusDiv.style.display = 'none';
                return; // Para o processamento se o campo estiver vazio
            }

            // Limpa a UI e inicia o estado de carregamento apenas se houver ingredientes
            resetUI(); // Reseta a interface, incluindo a mensagem inicial
            submitButton.disabled = true; // Desabilita o bot√£o
            processingStatusDiv.style.display = 'block'; // Mostra a √°rea de status
            startFakeAnimation(); // Inicia a anima√ß√£o cliente-side

            // Envia os dados via AJAX
            const formData = new FormData(form);
            fetch('/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                // Quando a resposta final do servidor chega
                if (response.ok) {
                   // O servidor respondeu com o HTML renderizado
                   return response.text(); // L√™ a resposta como texto (o HTML completo da p√°gina)
                } else {
                    // Erro na requisi√ß√£o (HTTP error like 400, 500)
                    // Tenta ler o corpo da resposta para incluir na mensagem de erro
                     return response.text().then(text => {
                         const errorMessage = `Erro HTTP ${response.status}: ${response.statusText}`;
                         console.error('Server response:', text); // Log the server response for debugging
                         // Attempt to extract a more specific error message from the response text if possible
                         // For now, just include the status text and basic error indication
                         throw new Error(`${errorMessage}. Verifique o console para mais detalhes.`);
                     });
                }
            })
            .then(html => {
                // Quando o HTML da resposta √© obtido com sucesso
                stopFakeAnimation(); // Para a anima√ß√£o fake

                // Para atualizar APENAS a √°rea de sa√≠da sem recarregar a p√°gina toda:
                // Criamos um elemento tempor√°rio para "parsear" o HTML recebido
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                // Encontra a √°rea de sa√≠da na resposta recebida
                const receivedOutputArea = tempDiv.querySelector('.recipe-output-area');

                if (receivedOutputArea) {
                    // Substitui o conte√∫do da √°rea de sa√≠da atual pelo conte√∫do recebido
                    // Isso inclui a receita renderizada OU a mensagem de erro do Flask (ex: sem ingredientes - embora j√° validemos no JS)
                    // O novo HTML j√° deve conter o bot√£o de download com os data-attributes e o download="" definidos por Flask
                    finalOutputDiv.innerHTML = receivedOutputArea.innerHTML;

                    // --- L√≥gica para o download ---
                    const downloadButton = finalOutputDiv.querySelector('#download-button'); // Encontra o NOVO bot√£o no DOM atualizado
                    if (downloadButton && downloadButton.dataset.markdownContent) {
                        const markdownContent = downloadButton.dataset.markdownContent;
                        const blob = new Blob([markdownContent], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        downloadButton.href = url; // Define o href com o URL do Blob
                        // O atributo download j√° foi definido por Flask/Jinja2
                    } else {
                        // Se o bot√£o n√£o foi encontrado ou n√£o tem o conte√∫do (ex: se houve um erro server-side que n√£o retornou receita)
                         console.warn("Bot√£o de download ou conte√∫do markdown n√£o encontrado na resposta.");
                         const existingDownloadButton = finalOutputDiv.querySelector('#download-button');
                         if(existingDownloadButton) existingDownloadButton.style.display = 'none'; // Esconde o bot√£o se ele apareceu mas sem conte√∫do
                    }


                } else {
                     // Se n√£o encontrar a √°rea de sa√≠da, algo deu errado na resposta do servidor ou na estrutura do HTML retornado
                     console.error('Erro ao parsear HTML de resposta: .recipe-output-area n√£o encontrado.');
                     finalOutputDiv.innerHTML = '<div class="error-message">Erro: N√£o foi poss√≠vel processar a resposta do servidor. Verifique o console para detalhes.</div>';
                }

                processingStatusDiv.style.display = 'none'; // Esconde o status de processamento
                submitButton.disabled = false; // Reabilita o bot√£o
            })
            .catch(error => {
                // Tratar erros de rede, erros HTTP, ou erros lan√ßados no .then() anterior
                console.error('Erro durante a forja:', error);
                stopFakeAnimation(); // Para a anima√ß√£o fake
                processingStatusDiv.style.display = 'none'; // Esconde status

                // Exibe a mensagem de erro na √°rea de sa√≠da final
                finalOutputDiv.innerHTML = `<div class="error-message">Um erro inesperado ocorreu: ${error.message || error}.</div>`;
                submitButton.disabled = false; // Reabilita o bot√£o
            });
        });

        // Garante que a UI est√° no estado correto ao carregar a p√°gina (√∫til em recargas)
        // Se h√° conte√∫do final (receita ou erro do Flask), a anima√ß√£o n√£o deve iniciar.
        // Se n√£o h√° conte√∫do final, exibe a mensagem inicial.
        window.addEventListener('load', function() {
            // Verifica se a √°rea de output j√° cont√©m receita renderizada ou mensagem de erro N√ÉO a mensagem info inicial
            const hasFinalContent = finalOutputDiv.querySelector('.recipe-content') || finalOutputDiv.querySelector('.error-message');

            if (!hasFinalContent) {
                // Se n√£o tem conte√∫do final (√© a primeira carga ou um erro inicial que limpou tudo),
                // garante que a mensagem informativa inicial est√° vis√≠vel e a √°rea de status escondida.
                processingStatusDiv.style.display = 'none';
                // Adiciona ou garante que a mensagem info existe se n√£o houver outro conte√∫do
                 if (!finalOutputDiv.querySelector('.info-message')) {
                      finalOutputDiv.innerHTML = `<div class="info-message">
                         <p>Sua receita √©pica aparecer√° aqui ap√≥s a forja!</p>
                         <p>Prepare seus utens√≠lios e acenda o fogo do drag√£o!</p>
                         <p>Informe os ingredientes que voc√™ possui para come√ßar!</p>
                     </div>`;
                 }

            } else {
                 // Se tem conte√∫do final (receita ou erro do Flask da √∫ltima submiss√£o),
                 // esconde a √°rea de status.
                 processingStatusDiv.style.display = 'none';

                 // Se houver uma receita renderizada (n√£o um erro), configura o link de download
                 const downloadButton = finalOutputDiv.querySelector('#download-button');
                 if (downloadButton && downloadButton.dataset.markdownContent) {
                     const markdownContent = downloadButton.dataset.markdownContent;
                     const blob = new Blob([markdownContent], { type: 'text/plain' });
                     const url = URL.createObjectURL(blob);
                     downloadButton.href = url;
                 } else if (downloadButton) {
                      // Se o bot√£o existe mas n√£o tem data-markdown (situa√ß√£o inesperada, talvez erro parcial)
                     console.warn("Bot√£o de download encontrado na carga inicial, mas sem conte√∫do markdown.");
                     downloadButton.style.display = 'none'; // Esconde o bot√£o problem√°tico
                 }
            }
             submitButton.disabled = false; // Garante que o bot√£o n√£o fica desabilitado ap√≥s recarga
        });


    </script>
</body>
</html>