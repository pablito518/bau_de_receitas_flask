<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ba√∫ de Receitas - Forja de Receitas √âpicas</title>
    <link rel="stylesheet" href="{{ url_for('static_files', filename='style.css') }}">
</head>
<body>
    <div class="main-container"> {# Add main-container class #}
        <h1>‚öîÔ∏è Ba√∫ de Receitas ‚öîÔ∏è</h1>
        <p>Bem-vindo ao Ba√∫ de Receitas! Entre na <strong>Forja de F√≥rmulas √âpicas</strong>!</p>
        <p>Informe os ingredientes que voc√™ possui em seu invent√°rio, e nossos Mestres Culin√°rios Alquimistas conjurar√£o uma receita exclusiva para voc√™.</p>
        <hr>

        <h2>üî• A Forja de F√≥rmulas √âpicas üî•</h2>

        <div class="input-area"> {# Optional: Add a class for input area if specific styling is needed #}
            <h3>üìú Ingredientes em Seu Invent√°rio:</h3>
            <form method="POST" id="recipe-form">
                <textarea name="ingredients" rows="4" placeholder="Ex: casca de ab√≥bora, talo de br√≥colis, p√£o amanhecido, cenoura murcha...">{{ ingredients }}</textarea>
                <button type="submit" id="submit-button">‚ú® FORJAR RECEITA! ‚ú®</button>
            </form>
        </div>

        <div class="recipe-output-area" > {# Add recipe-output-area class #}
            <h3>üìñ F√≥rmula M√°gica Revelada: üìñ</h3>
            
            {# √Årea para exibir mensagens de status durante o processamento #}
            {# Este div ser√° controlado INTEIRAMENTE pelo JavaScript no cliente #}
            <div id="processing-status" class="status-message" style="display: none;">
                <p id="current-status-text">Iniciando forja...</p>
                <div id="step-status-container">
                    <p id="buscador-status" class="step-status" id="buscador-status"><span>üîç Vasculhando tomos antigos por receitas compat√≠veis...</span></p>
                    <p id="planejador-status" class="step-status" id="planejador-status"><span>üó∫Ô∏è Decifrando e planejando a receita principal...</span></p>
                    <p id="redator-status" class="step-status" id="redator-status"><span>‚úçÔ∏è Transcrevendo o encantamento... digo, o tutorial da receita...</span></p>
                </div>
            </div>
            
            <div id="final-output">
                {% if error_message %}
                    <div class="error-message">{{ error_message }}</div> {# Add error-message class #}
                {% elif rendered_recipe_html %} {# <--- Use a nova vari√°vel para o HTML renderizado #}
                    <div class="recipe-content" id="final-output"> {# Add recipe-content class #}
                        {{ rendered_recipe_html | safe }} {# O | safe ainda √© necess√°rio pois agora √© HTML gerado por n√≥s #}
                    </div>
                    {# Use the sanitized filename passed from the Flask route #}
                    <a href="#" id="download-button" download="{{ download_filename }}">üìú Baixar Pergaminho da Receita</a>
                    <script>
                        // Dynamically set the download content
                        document.getElementById('download-button').onclick = function() {
                            // Use a vari√°vel com o conte√∫do Markdown original para o download
                            var content = `{{ raw_markdown_content_for_download | safe }}`; // <--- Use a vari√°vel para download
                            var blob = new Blob([content], { type: 'text/plain' });
                            this.setAttribute('href', URL.createObjectURL(blob));
                            // The 'download' attribute is already set by Flask
                        };
                    </script>

                {% else %}
                    <div class="info-message"> {# Mostra mensagem inicial se nada foi processado #}
                        <p>Sua receita √©pica aparecer√° aqui ap√≥s a forja!</p>
                        <p>Prepare seus utens√≠lios e acenda o fogo do drag√£o!</p>
                    </div>
                {% endif %}
            </div> {# Close final-output div #}
        </div>

        <hr>
        <div class="footer-custom"> {# Keep footer-custom class #}
            <p>&copy; 2025 Ba√∫ de Receitas. Todos os direitos reservados. Forjado com Magia e Aproveitamento.</p>
        </div>
    </div> {# Close main-container div #}

    <script>
        const form = document.getElementById('recipe-form');
        const submitButton = document.getElementById('submit-button');
        const processingStatusDiv = document.getElementById('processing-status');
        const currentStatusText = document.getElementById('current-status-text');
        const stepStatusContainer = document.getElementById('step-status-container');
        const buscadorStatus = document.getElementById('buscador-status');
        const planejadorStatus = document.getElementById('planejador-status'); // Corrigido ID
        const redatorStatus = document.getElementById('redator-status');
        const finalOutputDiv = document.getElementById('final-output'); // Onde o resultado final aparece
        const steps = [ // Ordem e elementos dos passos
            { id: 'buscador', element: buscadorStatus, text: 'üîç Pergaminhos encontrados!' },
            { id: 'planejador', element: planejadorStatus, text: 'üó∫Ô∏è Plano da receita tra√ßado!' }, // Corrigido ID
            { id: 'redator', element: redatorStatus, text: '‚úçÔ∏è A f√≥rmula m√°gica est√° pronta!' }
        ];
        let currentStepIndex = 0;
        let animationInterval = null; // Para controlar a anima√ß√£o fake

        // Fun√ß√£o para resetar a UI para o estado inicial ou de carregamento
        function resetUI() {
            submitButton.disabled = false;
            processingStatusDiv.style.display = 'none';
            finalOutputDiv.innerHTML = ''; // Limpa o conte√∫do final
            currentStepIndex = 0;
            if (animationInterval) {
                clearInterval(animationInterval); // Para anima√ß√£o fake
                animationInterval = null;
            }
             steps.forEach(step => {
                step.element.style.display = 'none';
                step.element.classList.remove('active');
            });
             currentStatusText.textContent = 'Iniciando forja...';
        }

         // Fun√ß√£o para iniciar a anima√ß√£o cliente-side fake
        function startFakeAnimation() {
             currentStepIndex = 0;
             // Mostra o primeiro passo imediatamente
             steps[currentStepIndex].element.style.display = 'block';
             steps[currentStepIndex].element.classList.add('active');
             currentStatusText.textContent = steps[currentStepIndex].text;

             // Inicia o intervalo para trocar de passo (anima√ß√£o fake)
             animationInterval = setInterval(() => {
                 // Marca o passo atual como n√£o ativo
                 steps[currentStepIndex].element.classList.remove('active');

                 // Avan√ßa para o pr√≥ximo passo
                 currentStepIndex++;

                 // Se for al√©m do √∫ltimo passo, volta para o primeiro
                 if (currentStepIndex >= steps.length) {
                     currentStepIndex = 0;
                     // Esconde todos os passos para simular "reiniciando"
                     steps.forEach(step => {
                         step.element.style.display = 'none';
                     });
                 }

                 // Mostra e ativa o novo passo atual
                 steps[currentStepIndex].element.style.display = 'block';
                 steps[currentStepIndex].element.classList.add('active');
                 currentStatusText.textContent = steps[currentStepIndex].text;

             }, 5500); // Troca de passo a cada 5 segundos e meio
        }


        // --- Event Listener para o formul√°rio ---
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Previne o envio padr√£o do formul√°rio

            resetUI(); // Reseta a interface

            submitButton.disabled = true; // Desabilita o bot√£o
            processingStatusDiv.style.display = 'block'; // Mostra a √°rea de status

            startFakeAnimation(); // Inicia a anima√ß√£o cliente-side

            // Envia os dados via AJAX
            const formData = new FormData(form);
            fetch('/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                // Quando a resposta final do servidor chega
                if (response.ok) {
                   // O servidor respondeu com o HTML renderizado
                   return response.text(); // L√™ a resposta como texto (o HTML completo da p√°gina)
                } else {
                    // Erro na requisi√ß√£o (HTTP error like 400, 500)
                    // Mesmo que o servidor retorne um template de erro, tratamos como erro aqui
                     return response.text().then(text => { // Tenta ler o corpo da resposta
                         throw new Error(`Erro HTTP ${response.status}: ${response.statusText}\n${text}`);
                     });
                }
            })
            .then(html => {
                // Quando o HTML da resposta √© obtido com sucesso
                stopFakeAnimation(); // Para a anima√ß√£o fake
                // Para atualizar APENAS a √°rea de sa√≠da sem recarregar a p√°gina toda:
                // Criamos um elemento tempor√°rio para "parsear" o HTML recebido
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                // Encontra a √°rea de sa√≠da na resposta recebida
                const receivedOutputArea = tempDiv.querySelector('.recipe-output-area');

                if (receivedOutputArea) {
                    // Substitui o conte√∫do da √°rea de sa√≠da atual pelo conte√∫do recebido
                    // Isso inclui a receita renderizada OU a mensagem de erro do Flask (ex: sem ingredientes)
                    finalOutputDiv.innerHTML = receivedOutputArea.innerHTML;
                } else {
                     // Se n√£o encontrar a √°rea de sa√≠da, algo deu errado na resposta do servidor
                     finalOutputDiv.innerHTML = '<div class="error-message">Erro: N√£o foi poss√≠vel processar a resposta do servidor.</div>';
                }

                 processingStatusDiv.style.display = 'none'; // Esconde o status de processamento
                 submitButton.disabled = false; // Reabilita o bot√£o
            })
            .catch(error => {
                // Tratar erros de rede ou erros lan√ßados no .then() anterior
                console.error('Erro durante a forja:', error);
                stopFakeAnimation(); // Para a anima√ß√£o fake
                 processingStatusDiv.style.display = 'none'; // Esconde status

                // Exibe a mensagem de erro na √°rea de sa√≠da final
                finalOutputDiv.innerHTML = `<div class="error-message">Um erro inesperado ocorreu: ${error.message || error}.</div>`;
                 submitButton.disabled = false; // Reabilita o bot√£o
            });
        });

        // Fun√ß√£o para parar a anima√ß√£o cliente-side
        function stopFakeAnimation() {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
             steps.forEach(step => {
                step.element.style.display = 'none';
                step.element.classList.remove('active');
            });
        }

        // Garante que a UI est√° no estado correto ao carregar a p√°gina (√∫til em recargas)
        // Se h√° conte√∫do final (receita ou erro do Flask), a anima√ß√£o n√£o deve iniciar.
        // Se n√£o h√° conte√∫do final, exibe a mensagem inicial.
        window.addEventListener('load', function() {
             const hasFinalContent = finalOutputDiv.children.length > 0 &&
                                    !finalOutputDiv.querySelector('.info-message');

            if (!hasFinalContent) {
                 // Se n√£o tem conte√∫do final (√© a primeira carga ou um erro inicial),
                 // mostra a mensagem informativa e esconde a √°rea de status.
                 processingStatusDiv.style.display = 'none';
                 const infoMsg = finalOutputDiv.querySelector('.info-message');
                 if (!infoMsg) { // Se a mensagem info n√£o existe (ex: ap√≥s um erro AJAX anterior), cria uma
                      finalOutputDiv.innerHTML = `<div class="info-message">
                         <p>Sua receita √©pica aparecer√° aqui ap√≥s a forja!</p>
                         <p>Prepare seus utens√≠lios e acenda o fogo do drag√£o!</p>
                        </div>`;
                 }
            } else {
                 // Se tem conte√∫do final (receita ou erro do Flask da √∫ltima submiss√£o),
                 // esconde a √°rea de status e mostra o conte√∫do final.
                 processingStatusDiv.style.display = 'none';
            }
             submitButton.disabled = false; // Garante que o bot√£o n√£o fica desabilitado ap√≥s recarga
        });


    </script>
</body>
</html>